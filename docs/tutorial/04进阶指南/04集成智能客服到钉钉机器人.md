---
sidebar_position: 4
---

# 集成智能客服到钉钉机器人

:::info 
本文适合对极态有一定了解的开发者，通过对本文的学习，你将获得以下收获：
1. 对极态[元素机制](../01概述/03元素规范)有一定程度的理解，有能力遵循元素机制自定义元素族类。
2. 将智能客服智能体集成到钉钉机器人。建议先完成[《5分钟开发一个AI应用（智能客服）》](../00快速上手/03-5分钟开发一个AI应用（智能客服）)的学习。

:::

## 效果预览

![智能体集成到钉钉机器人中](./img/jitairobot/最终效果_DingTalk.png)

---

## 前置准备

### 钉钉账号与企业创建

1. 注册并登录钉钉账号。
2. 创建属于自己的企业。

### 钉钉开发平台应用创建

1. 登录[钉钉开发者平台](https://open-dev.dingtalk.com)。
2. 进入`应用开发` → `企业内部应用` → `钉钉应用`。
3. 点击`创建应用`，设置应用名称、应用描述，创建完成后进入应用详情页。
4. 进入`应用能力` → `添加应用能力`，找到`机器人`并添加。
5. 机器人配置中的消息接收模式选择`Stream模式`。
6. 发布应用。
7. 创建一个企业内部群，并添加刚才创建的机器人。
8. 进入`基础信息` → `凭证与基础信息` → `应用凭证`。你可以看到`Client ID`和`Client Secret`，这两个参数将被设计为Type元素的可配置参数。

---

## 元素族类设计
极态[开发框架](../03开发指南/02开发框架/01概述)为开发者提供大量开箱即用的元素族类，并提供了对应的可视化配置界面。当已有元素族类无法满足需求时，开发者可以遵循[元素机制](../01概述/03元素规范)，定义自己的元素族类。

接下来，我们将定义一个元素族类，实现将智能客服集成到钉钉机器人的业务需求。

### Meta元素
fullName：`imRobots.meta`

所有与三方IM机器人对接的Type元素，其type值都指向`imRobots.meta`。
Meta元素还负责对Type元素的加载，当然也可以不实现，使用JitNode内置的加载逻辑。

### Type元素
fullName：`imRobots.dingTalkStreamType`

集成钉钉机器人SDK，封装消息收发、处理等技术实现，将可配置的参数开放出去（`clientId`和`clientSecret`）。
作为Type元素，还需要实现实例元素的加载逻辑。

### 实例元素
fullName：`imRobots.dingTalkDemo`

在配置文件中配置Type元素要求的参数：`clientId`和`clientSecret`。

---

### 元素目录结构

```shell title="imRobots元素族类的目录结构"
├── imRobots/
│   ├── meta/
│   │   ├── e.json
│   │   └── __init__.py
│   ├── dingTalkStreamType/
│   │   ├── e.json
│   │   └── loader.py
│   │   └── __init__.py
│   └── dingTalkDemo/
│       ├── e.json
│       └── config.json
│       └── __init__.py
└── ...

```



## 元素族类实现

### imRobots.meta Meta元素

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
  <TabItem value="ejson" label="meta/e.json">

```json title="e.json"
{
  "backendBundleEntry": ".",
  "type": "",
  "title": "IM机器人",
  "description": "所有和三方IM机器人对接相关的Type元素，都归属于IM机器人族类"
}
```

  </TabItem>
  <TabItem value="initpy" label="meta/__init__.py">

```python title="__init__.py"
# ...
```

  </TabItem>
</Tabs>

### imRobots.dingTalkStreamType Type元素

<Tabs>
  <TabItem value="ejson" label="dingTalkStreamType/e.json">

```json title="e.json"
{
  "backendBundleEntry": ".",
  "type": "imRobots.meta",
  "title": "钉钉机器人",
  "description": "封装钉钉机器人对接的细节，包括消息发送、接收、处理等，将配置参数开放"
}
```

  </TabItem>
  <TabItem value="loaderpy" label="dingTalkStreamType/loader.py">

```python title="loader.py"
import json
from .handler import TextHandler
from .client_manager import ClientManager
from jit.commons.utils.strutil import renderTemplateString

class Loader(object):
    def __init__(self, nodes):
        self.nodes = nodes

    def load(self):
        element=self.nodes[0]
        file=element.getFile("config.json")
        config = renderTemplateString(file, **app.envVars)
        config = json.loads(config)
        clientId = config.get("clientId")
        clientSecret = config.get("clientSecret")
        return self.start_client(clientId, clientSecret)

    def start_client(self,client_id: str, client_secret: str):
        """
        启动钉钉流式客户端
        
        Args:
            client_id: 钉钉应用的 Client ID
            client_secret: 钉钉应用的 Client Secret
            logger: 日志记录器
        """
        # 创建消息处理器
        message_handler = TextHandler(self.nodes[0])
        
        # 创建并启动客户端管理器
        client_manager = ClientManager(client_id, client_secret)
        client_manager.start(message_handler)
        
        return client_manager
```

  </TabItem>
  <TabItem value="initpy" label="dingTalkStreamType/__init__.py">

```python title="__init__.py"
from .loader import Loader

__all__ = ["Loader"]
```

  </TabItem>
</Tabs>

### imRobots.dingTalkDemo 实例元素

<Tabs>
  <TabItem value="ejson" label="dingTalkDemo/e.json">

```json title="e.json"
{
  "backendBundleEntry": ".",
  "backendLoadTime": "afterAppInit",
  "type": "imRobots.dingTalkStreamType",
  "title": "钉钉智能客服",
  "description": "JitAi智能客服钉钉机器人实例，配置具体参数"
}
```

  </TabItem>
  <TabItem value="configjson" label="dingTalkDemo/config.json">

```json title="config.json"
{
    "clientId": "<clientId>",
    "clientSecret": "<clientSecret>"
}
```

:::tip
`clientId`和`clientSecret`需要从钉钉开发者平台获取，在这里填写实际值。

有哪些配置是Type元素的loader.py决定的。
:::

  </TabItem>
</Tabs>

---

## 触发元素打包
删除dist目录，重启JitNode，到钉钉群中发送消息并@机器人，查看效果。






